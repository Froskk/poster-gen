const peakDistrictData = {
  viewBox: "0 0 382 596",
  xmlns: "http://www.w3.org/2000/svg",
  fill: "none",
  d:
    "M145.5.699998c.4-1.3 2.6 2.600002 2.6 2.600002.2.6.5 1.1.7 1.6.6 1.4 4.3-1.2 5.2-.4 2.4 2.2 5.1 7.1 6.8 9.9.3.5 4.6-2.8 5.3-2.8.2 0-.5 1-.7 1.2-2.3 1.6 1.9 4.3 2 7.9 0 1.2.3 9.4.8 10.1 2.2 3.1 7.2 3.2 9.7 6.3.5.6-4.7 13.9-3 16.4.1.1 8.2.7 8.4.2.1-.2 1.7-2 1.8-1.8 1.3 2.1 13.7 15.9 14.5 16 3.3.5 10.7-4.3 14-1.4 5.6 4.9 3.5 9.7 4.1 15.2.2 2.1 3.5 1.2 3.5 3.6 0 .3 10.6-1.7 12.1-2.2 5.5-1.9 14.5-1.1 20.4-2.2 1.2-.2 2.9-2 3.5-1 5.2 8.4.7 13.1 9.4 21.4 1.6 1.6 6.9 1.3 7.3 2 7.7 12.6 18.6 14.5 25.3 25.5.1.1.8.5 1 .4.3-.2 3.1-2 3.4-1.4 2.7 5.9 11.6 9.8 18.1 10.1 2.8.2 7-2 8.5.4 1.3 2.2-7.1 2.4-5.9 4.6.1.2 1 .4 1.2.6 1.5 1.1 4.6 1.1 6.6 1.8 1.9.6 10.4 8.4 16.2 9.3 1.4.2-3 1-3.7 2.2-1 1.6-9.5 7.9-9.1 9.1 1.5 4.3 6.2 2.6 8.6 12.3 1.2 4.6 1.1 6.6-.8 9.7-1.3 2.1 3.5 7.6 1.1 7.3-.5-.1-1.1-.7-1.5-.4-.4.3-.3 1-.5 1.4-.4.8-.6 1.7-1.7 1.4-.9-.2-1.8-.7-2.7-.6-3.5.3.4 2.1-.6 3.8-1.8 2.9-10 4-10 8.5 0 1.4 3.7 4.1 3.7 4.8 0 1.1-.1 10.8.6 11.3 5.6 4 12.4-3.2 17.5-1 .8.4-.9 2-.4 2.8.5.8-1.1 1.3-1.8 2.4-2.8 4.5-9 .3-12.5 1.8-1.7.7.5 3.7-.1 5.5-.6 1.9-5.5 2.3-5.5 4.5 0 .2.4-.3.6-.2 1.3.4-.7 3.3 1.3 3 9.6-1.2 2.1 4.6 4 9.3.8 2 13 4.6 13.8 8.5 1.7 8.4-3.7 13.5-3.7 20.8 0 .7 1.3-.1 2 0 3.5.5 8 2.4 8.8 4.4 2 5.1-2.3 7.9-5.4 10.1-.8.5 4.8 3.7 3 5.3-.4.4-1.2 1.1-1.4 1.6-.5 1.2-2.6 2.6-1.6 3.4 1.7 1.4 2 7.5 3 8.1 2.2 1.5 9.4 2.2 10.8 3.4 2.1 1.8-5.1 6.2-2.9 7.9 1.3.9 5.8 3.7 6.2 5.5.6 2.9-3 1.5-4.2 1.8-3.1.8-4.1 6.5-4.4 8.5-.1.6-3.3 5.5-3.2 5.5 1.8.4 4-.7 5.7-.2.4.1-.6 2.4-.7 2.6-1.3 3.4-.3 14.6.4 17.8.6 2.6 7 9.1 5.6 11.5-.8 1.4-3.2-.9-4.9-.8-.9.1.1 1.9.1 2.8-.1 3.2-1.5 7.4-.8 10.5.1.5 5.7.3 6.5.6 1.2.4-1.6 3.4-1.9 3.6-3 1.8 2.1 3.8 1.1 6-.3.7-4.3 3.9-4.1 4.4 1.2 2.5 2.5.6 4.2 0 .1 0 2.4 4.1 2.6 4.4 1.6 2.8 8.8-1 9.6 4.3 0 .4 1 .8.8 1.2-2.4 4-15.2 1.6-20.9 2.8-1.3.3-1.7 3.2-2.9 3.8-3.2 1.6-19.5 6.1-22.7 5-5.4-1.9-15.3-9.8-18.1-1.2-.8 2.2 2.3 4.2 2.6 6.5 1.1 8.5-.5 13.1-.5 19.8 0 .3.5 2.2.1 2.4-1.6.6-3.8 1.2-7.3 1.6-1.3.2 2.1 1.6 2.5 2.8 1 3.1-3.6 3.5-1.8 6.5 1.8 3.1 6.8.5 9.8 1.2 1.4.3 1.9 5.1 3.1 5.7 5.9 3 16.5 5.1 15.4 13.9-.9 7.2-11 .8-16.8 2.6-1.8.6 5.9 3.1 4.2 3.8-1.1.5-3.1.9-2.8 2 .7 2.5 4.6 5.2 6.4 6.5 2 1.6-1.9 7.4.7 7.7 1.8.2 8.8-1.6 8.8 1 0 .3-.3.1-.4.2-6.6 3.7-17.6 10.8-25.6 9.1-4.1-.9-11.3-3.5-10.8-9.5 0-.7-.1-2.1-1-2.2-1.4-.2-12.5 3.4-13 4.2-1.2 1.9-1.1 9.1-5.2 9.1-2 0-5.8-5-8.6-2.6-3.4 2.9-3.1 13.4-4 18.8-.7 4.4-9.4 10.9-11.4 17.2-2 6.4-1.2 9-2.6 16.6-.1.7-3.3 2.4-3.6 3-1.3 2.1-2.2 8.3-2.8 10.5-.2.8-3.4 1.3-3.8 2.4-.6 1.6 1.2 3.8-.4 5.2-1.4 1.2-3.6-1.6-5.5-1.4-.9.1-2.7 2.7-3.7 1.8-1.1-1-1-4-4.6-4-2.7 0-5.6 4-7.7 2.4-2.1-1.6-4.8-7.6-6.7-8.3-2.6-.9-4.5 2-6.8 1.2-.5-.2.1-2.6-1.2-3-5.3-1.8-5.5 6.5-6.4 7.9-.4.8-3-1.5-2.5-.8 2.9 4.2-2.7.2-5.9 1.2-.9.3-1.5 4-2.9 4.4-3.4 1-18.9-2-22.3-3.4-3.8-1.6-5.7-8.8-9.4-10.9-3.2-1.9-9.7-.6-13.2-2.4-3.9-2-4.1-9.5-7.7-11.3-10.2-5.1-38.8-26.5-44.4-40.2-4.1-10.3 3.2-32.6 1-36.2-.6-1-8.6-2.2-11.3-2.8-.1 0-1.1-7.4-2.2-7.7-4.6-1.2-1.4 4.6-5.2 7.7-.8.6-17.4-8.6-17.9-8.9-5.4-2.7-14 2.3-19.4-.4-10.6-5.3-4.2-23.3-11.8-27.7-4.4-2.5-10.4 2.7-14.3 1-1.5-.6-2.8-2.5-4.2-3-.69999-.2-1.79999 2.7-2.19999 1.4-2.2-7-.9-18.1-6.7-21-.1-.1 1.1-1.7 1.2-1.8 1.8-1.1 7.3-11.9 8.59999-11.9 1.9 0 4.5 4.9 6.7.8.4-.7 1.3-5.7 2.3-5.7 1.7 0 2.1 3.7 5.3 2.2 3.4-1.7 3.6-4 7.3-4 .6 0 0-6.8 1.5-9.3 1.1-1.7 4.7-3.3 5.3-5.5 2.4-8.5-17.2-23.3-17.3-24.5-.2-3.2 3.4-3 3.4-4.2 0-1.6-1-2.8-.5-5.5 0-.4 2.3-3.5 2-3.6-2-.9-1.2-3.1-2.8-4-1.4-.8-3.2-1.1-4.7-1.4-1.5-.4-1.1-4-1.1-4.4-.3-7.3 1.1-11 5.6-15.9.3-.3.5-.9.4-1.2-.5-1.3-4.2-1.6-4.6-3.6-2.1-10-5.9-15.5-11.29999-24.3-1-1.7 2.89999 1.1 2.99999 1.2 2 1.6 10.1-2.1 10.1-3 0-2 1.9-4.5 1.9-5.9 0-1.6-4.5-1.9-5.2-2.2-.2-.1-3.5-.4-3.5-.8 0-.5.7-2 1-2.2 5-4.4 4.2-12.6 9.2-17 .4-.3 5.1 3.6 6.5 3.2 2.7-.7-4.1-6.2-2-7.9 1.2-.9 3.3 4.5 3.4 3 .1-.7.7-14 1.7-13.3 1.7 1.2 4.2 6.3 4.9 6.5 2.9 1.1 5.9-1 8.7 2.2.9 1 1.5 5.8 1.2 6.7-.1.6-3.5 4.7-2.6 5.2 2.3 1.2 16.3 1.7 17.2 4.6.6 1.8-3.3 8.1-.7 8.9 5.5 1.7 15.6 8.6 20.5 13.9 2.1 2.3.3 7.2 1.7 9.5.3.6 1.4-.2 2 0 4.8 1.7-1.4-10.9 1.1-11.7 6.7-2.3 9.1 5.4 11.8 6.1 1.6.4 3.7-.9 5.6-.6 1.1.1 4.6 5.7 7.2 6.5.7.2 1.2-.4 1.8-.6 1.4-.5-.4-2.2.2-3.2 1.1-1.7 15-.5 16.2.2 4.7 2.7-.1 8-2 11.1-1.1 1.8-.7 7.9-2.8 9.1-.2.1-4.4-1.7-5.2-1.6-6 .6-13.4 11.9-16.7 10.5-.9-.4-2.4-.5-2.8.6-1.9 4.7 2.6 4.2 1.9 9.5-.9 6.9-7.9 4.3-7.9 13.3 0 7 9.4 5.1 10.2 10.1.7 4.1-2.5 12.2-2.5 16.8 0 1.1 2.3-.1 3.2.6 3.3 2.6 8.5 8.8 11.6 9.5 3.6.8 6.5-.3 8.2-3.2.4-.7 1.1 1.5 1.9 1.8 7.8 2.4 14.7.5 20.2 3.2 4.5 2.3 4.6 9.1 8.5 12.3 2 1.6 14.1 7 13.7 8.9-.3 1.1-1.4 2.9.2 2 .9-.5 6-2.3 6-2.8.1-5.5 2.3-5.8 2.6-7.1.4-1.9-2.8-.6-2.9-1.4-.2-1.8.6-3.6.5-5.2 0-.3-1.1-.6-1.2-.8-2.6-4.9-13-6.5-17.2-11.3-3-3.5-17.6-7.5-17.6-14.1 0-1.2 5.2-1.5 5.5-3.4.8-5-.3-7.7 3.7-8.3.9-.1 1.2-.3 1.4-1 .1-.5-.2-.5-.3-.8-.2-1-.5-7.1-2-9.3 0-.1-1.1-1-.7-1.2.4-.2 9.1.2 9.4.4 1.2.7 4 9.1 4.1 9.1 3.1.8 14.9-.5 16.2-2.6 1.2-1.9-5.5-4.7-7.3-7.7-1.6-2.7-4.5-9.3-3.4-11.1 1.2-2 4.2-5.1 2.4-6.5-2-1.6-3.2-5.1-5.6-6.9-1-.8-3.3-1.2-3-2.4.6-2.4 3.6-7.1 1.8-9.3-.8-1-4.6-4.2-4.7-4.4-.1-.5.7-.9 1-1.2 5.6-4.7 0-6.8-1.6-11.7-.3-.8 1.4-.7.6-1.4-3.4-2.8-9.6 4.4-10.9 5.3-1 .7-4 .6-4.3-1-.8-3.7-7-18-9.5-20.2-1.4-1.2.8-3.9-.2-5.5-.2-.3.1-1.8-.4-1.8-2.6 0-5.3-2.2-9-2.8-1.9-.3.6-4.7-1.1-5.7-3.9-2.2-9-3.5-12-6.1-.7-.6-.6 1.9-1.3 2.6-1.8 1.9-4.5 3.5-7.1 3.4-.3 0-.2-.7-.1-1 .1-.5-11.2-8.7-12.6-12.9-2.3-7.2-.6-11.2 4.2-17.2.3-.4 2.4-2.6 3-2.2 2.6 1.8 8.2 5.5 10.2 4.5 3.9-1.9-1.3-4 1.1-6.1.5-.4 10.3 1 10.3-.2 0-1-4.3-6.2-5.3-7.9-.7-1.1-7.1 2-7.8 1.6-.9-.6-7.5-3.8-10.2-3.8-1.9 0-6.2 2.6-7.6 2.2-.2 0-.6-3.9-.8-4.5-.5-1.5-5.7.1-6.5-1-2-2.9 2.1-7.3 1.6-9.1-.9-2.9-9.2-3.3-12-5.5-.1-.1.9-2.9 1.1-3.2 4-4.5-.5-9.3 5.8-11.3 2.5-.7 1.6-5.2 3.6-6.9.4-.4.9-1 1.4-1.4.3-.3 1.1-1.1 1.3-1.6.6-2-4.3-10.2-3.3-11.3 2.8-3 36.7 19.6 36.7-8.1 0-6.7-4.3-12-10-14.4-.5-.2-1.6 0-1.6-.6 0-1 2.5-10.7 2.3-10.7-4.3-1.2-7.3 3.5-10.6 3-8.5-1.3-8.4-10.6-13.4-15-.4-.4-.1-2.9-.1-3.8 0-5.5 3.8-8.6 4.4-13.3.4-3.2-2.3-6.8-.6-9.9 1.2-2.1 3.8-3.3 5.3-5.7.6-.9-2.1-.6-3-1.2-2.4-1.7-5.5-3.4-8.3-4.4-5.9-2.1-10.4-8.1-11.3-13.9-.3-2.1 11.1 1.9 11.2 1 .7-5.1 5-6.2 8.6-10.9.8-1-4.6 2.8-5 2.8-2.3 0-11.1-7.6-11.6-11.5-.1-.9.5-1.7.7-2.2 1.3-4 3.7-6.7 6.1-10.1.2-.3-2-1.2-2-1.2-.4-.3 1.3-4.5 1.8-5.1.6-.6.4-1.8 1.1-2.4.7-.6 3-2.3 3-3.1 0-1.5-1.9-4.9-2.8-8.3-.3-1-1.9-2.4-1-2.8 4.5-2.2 9.3-5.6 14.3-8.7 1.7-1.1 11.5.3 13.4-.2 1.6-.4 2.3 1 3.2-.6 3.1-5.5 19-10.1 24.2-7.1 1.3.8 4.2-2.5 6.2-1.8.8.3 2.7-1.79999577 2.4-.999996l1.3-.100006"
};

/**
 * Represents an SVG Node to clone use in Poster
 *
 * @param {*} pathData - Contains svg metadata and path data
 * @returns svg - HTML SVG Node
 */
const SVG = function(pathData) {
  const svg = document.createElementNS(pathData.xmlns, "svg");
  const path = svg.appendChild(
    document.createElementNS(pathData.xmlns, "path")
  );

  svg.setAttribute("viewBox", pathData.viewBox);
  svg.setAttribute("xmlns", pathData.xmlns);
  svg.setAttribute("fill", pathData.fill);
  path.setAttribute("d", pathData.d);

  return svg;
};

/**
 * Represents the image, contains information for rendering a repeating svg pattern
 * @constructor
 * @param {*} svg - An SVG Node element used as the repeating pattern
 * @param {*} target - An HTML element to repeating svg nodes
 */
//   this.setAttr = (attr, value) => {
//     if (this.hasOwnProperty(attr)) {
//       if (attr === "copies") {
//       }
//       this[attr] = value;
//       this.render();
//     }
//   };

//   this.render();
// };

const poster = {
  _nodes: [],
  _svg: new SVG(peakDistrictData),
  _copies: 14,
  _scale: 0.2,
  _offsetX: -3,
  _offsetY: 6,
  _minimumSize: 0.3,
  _fill: true,
  _startColor: "#5CCFE6",
  _endColor: "#560014",

  set nodes(amount) {
    const difference = amount - this.nodes.length;

    if (difference === 0) {
      // console.log("Same number of copies requested");
    } else {
      if (difference > 0) {
        // Create additional copies
        // e.g. 5 exist and 7 are called for
        const target = document.querySelector(".wrapper");
        for (let i = 0; i < difference; i++) {
          const svgClone = this._svg.cloneNode({ deep: true });
          target.appendChild(svgClone);
          // target.insertAdjacentElement("afterbegin", svgClone);
        }
      }

      if (difference < 0) {
        // Remove copies from end of NodeList
        // e.g. 10 exist and 8 are called for
        const oldNodes = this.nodes.slice(amount);
        oldNodes.forEach(node => node.remove());
        // Takes last 2 nodes and removes them
      }

      this.update();
      this._nodes = [].slice.call(document.querySelectorAll("svg"));
    }
  },

  get nodes() {
    const nodes = [].slice.call(document.querySelectorAll("svg"));
    return nodes;
  },

  set copies(value) {
    this._copies = value;
    this.nodes = value;
  },

  get copies() {
    return this._copies;
  },

  set scale(value) {
    this._scale = value;
    this.update();
  },

  get scale() {
    return this._scale;
  },

  set offsetX(value) {
    this._offsetX = value;
    this.update();
  },

  get offsetX() {
    return this._offsetX;
  },

  set offsetY(value) {
    this._offsetY = value;
    this.update();
  },

  get offsetY() {
    return this._offsetY;
  },

  set minimumSize(value) {
    this._minimumSize = value;
    this.update();
  },

  get minimumSize() {
    return this._minimumSize;
  },

  set fill(value) {
    this._fill = value;
    this.update();
  },

  get fill() {
    return this._fill;
  },
  set startColor(value) {
    this._startColor = value;
    this.update();
  },

  get startColor() {
    return this._startColor;
  },
  set endColor(value) {
    this._endColor = value;
    this.fill
      ? (document.querySelector(".wrapper").style.background = poster.endColor)
      : null;
    this.update();
  },

  get endColor() {
    return this._endColor;
  },

  // TODO: only rescale when adding new nodes, ensure old nodes are removed in correct order
  // FIXME: performance massive decreased with large scaling. Try scaling with viewBox
  update() {
    const chromaScale = chroma
      .scale([this.startColor, this.endColor])
      .mode("lch")
      .correctLightness()
      .colors(this.nodes.length);

    this.nodes.forEach((node, index) => {
      const reverseIndex = this.nodes.length - index - 1;

      const scaleFactor = this.minimumSize + this.scale * reverseIndex;
      const offsetX = reverseIndex * this.offsetX;
      const offsetY = reverseIndex * this.offsetY;

      node.setAttribute(
        "transform",
        `scale(${scaleFactor}) translate(${offsetX}, ${-offsetY})`
      );
      node.setAttribute("stroke-width", 1 / scaleFactor);
      node.setAttribute("stroke", chromaScale[reverseIndex]);

      this.fill ? node.setAttribute("fill", chromaScale[reverseIndex]) : null;
    });
  }
};

/**
 * Instantiates dat.gui which controls the SVG pattern
 *
 * @param {*} binding - The instance of the controlled object
 * @returns gui - Controller library
 */
const initGUI = binding => {
  const gui = new dat.GUI();
  gui.add(binding, "copies", 1, 25).step(1);
  gui.add(binding, "scale", 0.1, 2).step(0.1);
  gui.add(binding, "offsetX", -20, 20);
  gui.add(binding, "offsetY", -20, 20);
  gui.add(binding, "minimumSize", 0.1, 2);
  gui.add(binding, "fill", true);
  gui.addColor(binding, "startColor");
  gui.addColor(binding, "endColor");

  // IDEA: shadows on svg with feOffset

  gui.open();

  return gui;
};

/**
 * Neat logging provided whenever a change occurs in dat.gui
 * Bound to each controller element in gui
 *
 * @param {*} property
 * @param {*} value
 */
const guiLog = (property, value) => {
  console.log(
    "Prop: %c" + property + "%c Val: %c" + value,
    "color: #5CCFE6",
    "color: none",
    "color: #ffc900"
  );
};

window.onload = function() {
  const gui = initGUI(poster);

  gui.__controllers.map(controller => {
    controller.onChange(value => {
      // guiLog(controller.property, value);
      poster[controller.property] = value;
    });
  });

  poster.nodes = poster.copies;
  poster.endColor = poster._endColor;
};
